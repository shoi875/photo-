<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>撮影ログ Pro</title>
    
    <!-- iPhone App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="撮影ログ">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042339.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        :root { 
            --ios-blue: #007AFF; 
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --input-bg: #f2f2f7;
            --border-color: #e5e5ea;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #000000;
                --card-bg: #1c1c1e;
                --text-main: #ffffff;
                --text-sub: #8e8e93;
                --input-bg: #2c2c2e;
                --border-color: #38383a;
            }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease;
        }

        input, select, textarea { 
            font-size: 16px !important; 
            background-color: var(--input-bg) !important;
            color: var(--text-main) !important;
        }

        .safe-area-top { padding-top: env(safe-area-inset-top); }
        
        .segmented-control { 
            background: rgba(118, 118, 128, 0.12); 
            padding: 2px; 
            border-radius: 8px; 
            display: flex; 
        }
        .segmented-control button { 
            flex: 1; 
            padding: 6px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: 600; 
            transition: all 0.2s; 
            color: var(--text-main);
        }
        .segmented-control button.active { 
            background: var(--card-bg); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.12); 
        }

        .big-number { font-size: 1.5rem; font-weight: 800; line-height: 1; color: var(--text-main); }
        
        .list-values-row {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-main);
            white-space: nowrap;
            letter-spacing: -0.02em;
        }
        .list-unit {
            font-size: 0.75rem;
            color: var(--text-sub);
            margin-right: 2px;
            font-weight: 400;
        }

        .ios-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        .header-blur {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        @media (prefers-color-scheme: dark) {
            .header-blur {
                background-color: rgba(28, 28, 30, 0.8);
            }
        }

        /* 認証オーバーレイ */
        #authOverlay {
            background-color: var(--bg-color);
            z-index: 100;
        }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- 認証オーバーレイ -->
    <div id="authOverlay" class="fixed inset-0 flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500">
        <div class="mb-8">
            <div class="w-20 h-20 bg-blue-500 rounded-2xl mx-auto flex items-center justify-center shadow-xl mb-4">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">アプリはロックされています</h2>
            <p class="text-[#8e8e93] text-sm">Face ID または Touch ID で<br>ロックを解除してください</p>
        </div>
        <button id="authBtn" class="bg-blue-500 text-white font-bold py-4 px-8 rounded-full shadow-lg active:scale-95 transition-transform">
            ロックを解除
        </button>
    </div>

    <div id="appContent" class="opacity-0 pointer-events-none transition-opacity duration-500">
        <div class="safe-area-top header-blur border-b sticky top-0 z-30 shadow-sm border-[var(--border-color)]">
            <div class="px-4 py-3 flex items-center justify-between">
                <h1 class="text-xl font-extrabold tracking-tight">撮影ログ Pro</h1>
                <div class="segmented-control w-40">
                    <button id="viewToggleCard" class="active">カード</button>
                    <button id="viewToggleTable">リスト</button>
                </div>
            </div>
        </div>

        <main class="max-w-md mx-auto px-4 mt-6">
            <!-- フォームコンテナ -->
            <div id="formContainer" class="ios-card rounded-2xl p-5 shadow-sm mb-6 border-2 border-transparent transition-all overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="formTitle" class="text-sm font-bold text-[#8e8e93] uppercase tracking-widest">新規記録</h2>
                    <button id="cancelEdit" class="hidden text-xs font-bold text-red-500">キャンセル</button>
                </div>
                <form id="photoLogForm" class="space-y-4">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-[#8e8e93] mb-1">日付</label>
                            <input type="date" id="date" required class="w-full px-3 py-2 rounded-xl border-none ring-1 ring-[var(--border-color)] focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#8e8e93] mb-1">場所 / 会場</label>
                            <input type="text" id="location" placeholder="撮影地" required class="w-full px-3 py-2 rounded-xl border-none ring-1 ring-[var(--border-color)] focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs font-bold text-[#8e8e93] mb-1">ISO感度</label>
                            <select id="iso" required class="w-full px-3 py-2 rounded-xl border-none ring-1 ring-[var(--border-color)] focus:ring-2 focus:ring-blue-500 outline-none appearance-none"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#8e8e93] mb-1">シャッター</label>
                            <select id="shutter" required class="w-full px-3 py-2 rounded-xl border-none ring-1 ring-[var(--border-color)] focus:ring-2 focus:ring-blue-500 outline-none appearance-none"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#8e8e93] mb-1">絞り (F値)</label>
                            <select id="aperture" required class="w-full px-3 py-2 rounded-xl border-none ring-1 ring-[var(--border-color)] focus:ring-2 focus:ring-blue-500 outline-none appearance-none"></select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-[#8e8e93] mb-1">ホワイトバランス</label>
                        <select id="wb" class="w-full px-3 py-2 rounded-xl border-none ring-1 ring-[var(--border-color)] focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                            <option value="Auto">Auto (自動)</option>
                            <option value="太陽光">太陽光</option>
                            <option value="日陰">日陰</option>
                            <option value="曇天">曇天</option>
                            <option value="白熱電球">白熱電球</option>
                            <option value="蛍光灯">蛍光灯</option>
                            <option value="フラッシュ">フラッシュ</option>
                            <option value="マニュアル (K)">マニュアル (色温度K)</option>
                        </select>
                    </div>

                    <div id="wbKDetails" class="hidden grid grid-cols-2 gap-2 p-3 bg-blue-500/10 rounded-xl border border-blue-500/20">
                        <div>
                            <label class="block text-[10px] font-black text-blue-500 mb-1">色温度 (K)</label>
                            <input type="number" id="wbKelvin" placeholder="5500" class="w-full px-3 py-1 text-sm rounded-lg border-none ring-1 ring-blue-500/30 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-blue-500 mb-1">補正 (G-M)</label>
                            <input type="text" id="wbGM" placeholder="G1.0" class="w-full px-3 py-1 text-sm rounded-lg border-none ring-1 ring-blue-500/30 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-[#8e8e93] mb-1">メモ</label>
                        <textarea id="memo" rows="2" placeholder="使用レンズや天候など" class="w-full px-3 py-2 rounded-xl border-none ring-1 ring-[var(--border-color)] focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-[#007AFF] text-white font-bold py-3 rounded-xl shadow-lg active:opacity-70 transition-opacity">
                        ログを保存する
                    </button>
                </form>
            </div>

            <div class="sticky top-20 z-20 pb-4">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </span>
                    <input type="text" id="searchInput" placeholder="検索..." class="pl-10 w-full px-4 py-2 ios-card rounded-full border-none shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div id="logContainer" class="space-y-4"></div>
            
            <div id="tableView" class="hidden ios-card rounded-2xl overflow-hidden shadow-sm border-[var(--border-color)]">
                <div class="bg-[rgba(118,118,128,0.08)] text-[#8e8e93] uppercase font-black text-[10px] px-4 py-2 flex justify-between">
                    <span>場所 / 日付</span>
                    <span>設定値 (ISO · SS · F値)</span>
                </div>
                <div id="tableBody" class="divide-y divide-[var(--border-color)]"></div>
            </div>

            <p id="noDataMessage" class="hidden text-center py-12 text-[#8e8e93] italic">データがありません</p>

            <div class="mt-12 mb-8 text-center flex flex-col items-center gap-6">
                <div class="flex gap-4">
                    <button id="exportData" class="text-xs text-blue-500 font-bold">CSV出力</button>
                    <button id="clearAll" class="text-xs text-red-400 font-bold">全消去</button>
                </div>
                <button id="manualLockBtn" class="text-xs text-[#8e8e93] flex items-center gap-1">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                    アプリをロックする
                </button>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-all pointer-events-none z-50 text-sm font-bold">
        保存完了
    </div>

    <script>
        // 生体認証ロジック
        async function authenticateUser() {
            // ブラウザが生体認証をサポートしているか確認
            if (!window.PublicKeyCredential) {
                unlockApp(); // サポート外の場合はそのまま解除
                return;
            }

            try {
                // iOSのパスキー/生体認証を呼び出すためのダミーの認証要求
                // 本来はサーバーサイドと連携しますが、ローカルのみの場合は
                // デバイスの画面ロック（パスコード/FaceID）をトリガーにします
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                // ローカル認証のトリガー（iOS 16+ / パスキー対応）
                // 認証が成功すると解決されます
                const authSuccess = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                
                if (authSuccess) {
                    unlockApp();
                } else {
                    alert("このデバイスでは生体認証を利用できません。");
                    unlockApp();
                }
            } catch (err) {
                console.error("Authentication error:", err);
                // エラー時はユーザーに再試行を促す
            }
        }

        function unlockApp() {
            document.getElementById('authOverlay').classList.add('opacity-0', 'pointer-events-none');
            const content = document.getElementById('appContent');
            content.classList.remove('opacity-0', 'pointer-events-none');
            content.classList.add('opacity-100');
        }

        function lockApp() {
            document.getElementById('authOverlay').classList.remove('opacity-0', 'pointer-events-none');
            const content = document.getElementById('appContent');
            content.classList.add('opacity-0', 'pointer-events-none');
        }

        document.getElementById('authBtn').onclick = authenticateUser;
        document.getElementById('manualLockBtn').onclick = lockApp;

        // 初期化
        window.onload = () => {
            // データがある場合のみロックを表示
            if (logs.length > 0) {
                authenticateUser();
            } else {
                unlockApp();
            }
        };

        const isoList = [50, 100, 125, 160, 200, 250, 320, 400, 500, 640, 800, 1000, 1250, 1600, 2000, 2500, 3200, 4000, 5000, 6400, 8000, 10000, 12800, 25600, 51200];
        const shutterList = ["1/8000","1/6400","1/5000","1/4000","1/3200","1/2500","1/2000","1/1600","1/1250","1/1000","1/800","1/640","1/500","1/400","1/320","1/250","1/200","1/160","1/125","1/100","1/80","1/60","1/50","1/40","1/30","1/25","1/20","1/15","1/13","1/10","1/8","1/6","1/5","1/4","0.3\"","0.4\"","0.5\"","0.6\"","0.8\"","1\"","1.3\"","1.6\"","2\"","2.5\"","3.2\"","4\"","5\"","6\"","8\"","10\"","13\"","15\"","20\"","25\"","30\"","B"];
        const apertureList = ["1.0","1.1","1.2","1.4","1.6","1.8","2.0","2.2","2.5","2.8","3.2","3.5","4.0","4.5","5.0","5.6","6.3","7.1","8.0","9.0","10","11","13","14","16","18","20","22","25","29","32"];

        function populateSelect(id, list, defaultVal) {
            const el = document.getElementById(id);
            el.innerHTML = list.map(v => `<option value="${v}">${v}</option>`).join('');
            el.value = defaultVal;
        }

        populateSelect('iso', isoList, 100);
        populateSelect('shutter', shutterList, "1/1000");
        populateSelect('aperture', apertureList, "2.8");

        const form = document.getElementById('photoLogForm');
        const formContainer = document.getElementById('formContainer');
        const formTitle = document.getElementById('formTitle');
        const submitBtn = document.getElementById('submitBtn');
        const cancelEdit = document.getElementById('cancelEdit');
        const logContainer = document.getElementById('logContainer');
        const tableView = document.getElementById('tableView');
        const tableBody = document.getElementById('tableBody');
        const noDataMessage = document.getElementById('noDataMessage');
        const searchInput = document.getElementById('searchInput');
        const wbSelect = document.getElementById('wb');
        const wbKDetails = document.getElementById('wbKDetails');
        const toast = document.getElementById('toast');
        const btnCard = document.getElementById('viewToggleCard');
        const btnTable = document.getElementById('viewToggleTable');

        let currentView = 'card';
        let logs = JSON.parse(localStorage.getItem('photoLogs')) || [];
        let isEditing = false;

        document.getElementById('date').valueAsDate = new Date();

        wbSelect.addEventListener('change', () => {
            wbKDetails.classList.toggle('hidden', wbSelect.value !== 'マニュアル (K)');
        });

        function showToast(message) {
            toast.textContent = message;
            toast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 2000);
        }

        function deleteLog(id) {
            if(!confirm('削除しますか？')) return;
            logs = logs.filter(l => l.id !== id);
            localStorage.setItem('photoLogs', JSON.stringify(logs));
            render();
        }

        function editLog(id) {
            const log = logs.find(l => l.id === id);
            if (!log) return;
            isEditing = true;
            
            formContainer.classList.remove('hidden');

            document.getElementById('editId').value = log.id;
            document.getElementById('date').value = log.date;
            document.getElementById('location').value = log.location;
            document.getElementById('iso').value = log.iso;
            document.getElementById('shutter').value = log.shutter;
            document.getElementById('aperture').value = log.aperture;
            document.getElementById('wb').value = log.wb;
            document.getElementById('memo').value = log.memo;
            formTitle.textContent = "記録を編集";
            submitBtn.textContent = "更新する";
            cancelEdit.classList.remove('hidden');
            formContainer.classList.add('border-blue-500', 'bg-blue-500/5');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            wbKDetails.classList.toggle('hidden', log.wb !== 'マニュアル (K)');
        }

        cancelEdit.onclick = () => {
            isEditing = false;
            form.reset();
            document.getElementById('date').valueAsDate = new Date();
            formTitle.textContent = "新規記録";
            submitBtn.textContent = "ログを保存する";
            cancelEdit.classList.add('hidden');
            formContainer.classList.remove('border-blue-500', 'bg-blue-500/5');
            wbKDetails.classList.add('hidden');
            updateFormVisibility();
        };

        function updateFormVisibility() {
            if (isEditing) {
                formContainer.classList.remove('hidden');
            } else {
                if (currentView === 'table') {
                    formContainer.classList.add('hidden');
                } else {
                    formContainer.classList.remove('hidden');
                }
            }
        }

        function render() {
            const term = searchInput.value.toLowerCase();
            const filtered = logs.filter(l => 
                l.location.toLowerCase().includes(term) || l.memo.toLowerCase().includes(term) || l.date.includes(term)
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            noDataMessage.classList.toggle('hidden', filtered.length > 0);
            logContainer.classList.toggle('hidden', currentView !== 'card' || filtered.length === 0);
            tableView.classList.toggle('hidden', currentView !== 'table' || filtered.length === 0);
            
            updateFormVisibility();

            if (currentView === 'card') {
                logContainer.innerHTML = filtered.map(log => `
                    <div class="ios-card rounded-2xl p-4 shadow-sm relative mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-[10px] font-black text-blue-500">${log.date}</span>
                                <h3 class="text-lg font-bold text-[var(--text-main)]">${log.location}</h3>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editLog('${log.id}')" class="text-blue-500 p-1">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                                <button onclick="deleteLog('${log.id}')" class="text-gray-400 p-1">×</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div class="bg-[rgba(118,118,128,0.08)] p-2 rounded-xl text-center">
                                <div class="text-[10px] font-bold text-[#8e8e93] uppercase">ISO</div>
                                <div class="big-number">${log.iso}</div>
                            </div>
                            <div class="bg-[rgba(118,118,128,0.08)] p-2 rounded-xl text-center">
                                <div class="text-[10px] font-bold text-[#8e8e93] uppercase">SS</div>
                                <div class="big-number">${log.shutter}</div>
                            </div>
                            <div class="bg-[rgba(118,118,128,0.08)] p-2 rounded-xl text-center">
                                <div class="text-[10px] font-bold text-[#8e8e93] uppercase">F値</div>
                                <div class="big-number">f/${log.aperture}</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-[11px] font-bold">
                            <span class="px-2 py-1 bg-blue-500/10 text-blue-500 rounded">WB: ${log.wb}</span>
                        </div>
                        ${log.memo ? `<p class="text-xs text-[#8e8e93] mt-2 pt-2 border-t border-[var(--border-color)]">${log.memo}</p>` : ''}
                    </div>
                `).join('');
            } else {
                tableBody.innerHTML = filtered.map(log => `
                    <div class="px-4 py-4 flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-[var(--text-main)] leading-tight">${log.location}</span>
                                <span class="text-[10px] text-[#8e8e93]">${log.date}</span>
                            </div>
                            <div class="flex gap-4 items-center">
                                <button onclick="editLog('${log.id}')" class="text-blue-500 font-bold text-xs px-2 py-1 border border-blue-500/20 rounded-lg bg-blue-500/10">編集</button>
                                <button onclick="deleteLog('${log.id}')" class="text-red-400 font-bold text-xs px-1">削除</button>
                            </div>
                        </div>
                        <div class="list-values-row bg-[rgba(118,118,128,0.05)] p-2 rounded-lg border border-[var(--border-color)] flex justify-between items-center">
                            <div><span class="list-unit">ISO</span>${log.iso}</div>
                            <div class="text-[var(--border-color)]">|</div>
                            <div><span class="list-unit">SS</span>${log.shutter}</div>
                            <div class="text-[var(--border-color)]">|</div>
                            <div><span class="list-unit">F</span>${log.aperture}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const logData = {
                date: document.getElementById('date').value,
                location: document.getElementById('location').value,
                iso: document.getElementById('iso').value,
                shutter: document.getElementById('shutter').value,
                aperture: document.getElementById('aperture').value,
                wb: document.getElementById('wb').value,
                memo: document.getElementById('memo').value
            };
            if (isEditing) {
                const id = document.getElementById('editId').value;
                const index = logs.findIndex(l => l.id === id);
                if (index !== -1) {
                    logs[index] = { ...logData, id };
                    showToast('更新しました');
                }
                cancelEdit.onclick();
            } else {
                logs.push({ ...logData, id: Date.now().toString() });
                showToast('保存しました');
            }
            localStorage.setItem('photoLogs', JSON.stringify(logs));
            form.reset();
            document.getElementById('date').valueAsDate = new Date();
            render();
        });

        searchInput.addEventListener('input', render);
        btnCard.onclick = () => { currentView = 'card'; btnCard.classList.add('active'); btnTable.classList.remove('active'); render(); };
        btnTable.onclick = () => { currentView = 'table'; btnTable.classList.add('active'); btnCard.classList.remove('active'); render(); };
        document.getElementById('clearAll').onclick = () => { if(confirm('全消去しますか？')) { logs=[]; localStorage.removeItem('photoLogs'); render(); }};
        
        document.getElementById('exportData').onclick = () => {
            const csv = '日付,場所,ISO,SS,F値,WB,メモ\n' + logs.map(l => `${l.date},${l.location},${l.iso},${l.shutter},${l.aperture},${l.wb},${l.memo}`).join('\n');
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
            link.download = 'photo_logs.csv';
            link.click();
        };
        render();
    </script>
</body>
</html>